{% extends 'base.html' %}

{% block content %}
<div id="agent-ticket-root" 
     class="max-w-7xl mx-auto p-6" 
     x-data="ticketForm()"
     @user-selected="handleSelection($event.detail)">
    
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-prime-navy dark:text-white">New Ticket (Agent)</h1>
        <a href="{% url 'workspace' %}" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
    </div>

    <form method="post" enctype="multipart/form-data" id="agent-ticket-form">
        {% csrf_token %}
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4 border-b pb-2">1. Classification & Contact</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-6">
                    
                    <div class="relative" @click.away="openContact = false">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Requester</label>
                        <input type="hidden" name="contact" id="id_contact" :value="selectedContact ? selectedContact.id : ''">

                        <div x-show="!selectedContact">
                            <input type="text" id="contact-search" name="q"
                                   class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-prime-orange dark:bg-gray-700 dark:text-white"
                                   placeholder="Start typing name..."
                                   autocomplete="off"
                                   @focus="openContact = true"
                                   hx-get="{% url 'hx_search_users' %}"
                                   hx-trigger="keyup changed delay:200ms, focus"
                                   hx-target="#contact-results"
                                   hx-vals='{"target": "contact"}'>
                            <div id="contact-results" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto" x-show="openContact" style="display: none;"></div>
                        </div>

                        <div x-show="selectedContact" style="display: none;" class="flex items-center justify-between p-2 pl-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md shadow-sm">
                            <div class="flex items-center gap-3">
                                <img :src="selectedContact?.avatar" class="w-8 h-8 rounded-full border border-blue-200 dark:border-blue-700 object-cover">
                                <div>
                                    <p class="text-sm font-bold text-prime-navy dark:text-white" x-text="selectedContact?.name"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Requester Selected</p>
                                </div>
                            </div>
                            <button type="button" @click="removeUser('contact')" class="p-1.5 text-gray-400 hover:text-red-500 rounded-full hover:bg-white dark:hover:bg-gray-800 transition">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div id="contact-details" class="grid grid-cols-2 gap-4 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-md border border-gray-200 dark:border-gray-600">
                        <div class="col-span-2"><label class="block text-xs text-gray-500">Email</label><input type="text" disabled class="w-full text-sm bg-transparent border-none p-0 text-gray-700 dark:text-gray-200" placeholder="..."></div>
                        <div><label class="block text-xs text-gray-500">Department</label><input type="text" disabled class="w-full text-sm bg-transparent border-none p-0 text-gray-700 dark:text-gray-200" placeholder="..."></div>
                        <div><label class="block text-xs text-gray-500">Location</label><input type="text" disabled class="w-full text-sm bg-transparent border-none p-0 text-gray-700 dark:text-gray-200" placeholder="..."></div>
                    </div>

                    <div class="relative" @click.away="openTech = false">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Assignee</label>
                            <button type="button" x-show="!selectedTech" class="text-xs text-prime-orange font-bold hover:underline" onclick="assignToMe()">Assign to Me</button>
                        </div>
                        
                        <input type="hidden" name="technician" id="id_technician" :value="selectedTech ? selectedTech.id : ''">
                        
                        <div x-show="!selectedTech">
                            <input type="text" id="tech-search" name="q"
                                   class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-prime-orange dark:bg-gray-700 dark:text-white"
                                   placeholder="Unassigned"
                                   autocomplete="off"
                                   @focus="openTech = true"
                                   hx-get="{% url 'hx_search_users' %}"
                                   hx-trigger="keyup changed delay:200ms, focus"
                                   hx-target="#tech-results"
                                   hx-vals='{"target": "technician", "variant": "compact"}'> <div id="tech-results" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto" x-show="openTech" style="display: none;"></div>
                        </div>

                        <div x-show="selectedTech" style="display: none;" class="flex items-center justify-between p-2 pl-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-md shadow-sm">
                            <div class="flex items-center gap-3">
                                <img :src="selectedTech?.avatar" class="w-8 h-8 rounded-full border border-purple-200 dark:border-purple-700 object-cover">
                                <div>
                                    <p class="text-sm font-bold text-prime-navy dark:text-white" x-text="selectedTech?.name"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Technician Assigned</p>
                                </div>
                            </div>
                            <button type="button" @click="removeUser('technician')" class="p-1.5 text-gray-400 hover:text-red-500 rounded-full hover:bg-white dark:hover:bg-gray-800 transition">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>

                    <div class="relative" @click.away="openCollab = false">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Collaborators (Optional)</label>
                        
                        <template x-for="c in selectedCollaborators" :key="c.id">
                            <input type="hidden" name="collaborators" :value="c.id">
                        </template>

                        <input type="text" id="collab-search" name="q"
                               class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-prime-orange dark:bg-gray-700 dark:text-white mb-2"
                               placeholder="Add a collaborator..."
                               autocomplete="off"
                               @focus="openCollab = true"
                               hx-get="{% url 'hx_search_users' %}"
                               hx-trigger="keyup changed delay:200ms, focus"
                               hx-target="#collab-results"
                               hx-vals='{"target": "collaborators", "variant": "compact"}'> <div id="collab-results" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto" x-show="openCollab" style="display: none;"></div>

                        <div class="flex flex-wrap gap-2 mt-2">
                            <template x-for="(c, index) in selectedCollaborators" :key="c.id">
                                <div class="inline-flex items-center bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-full px-2 py-1">
                                    <img :src="c.avatar" class="w-5 h-5 rounded-full mr-2">
                                    <span class="text-xs font-medium text-gray-700 dark:text-gray-200" x-text="c.name"></span>
                                    <button type="button" @click="selectedCollaborators.splice(index, 1)" class="ml-2 text-gray-400 hover:text-red-500">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Board</label>{{ master_form.board }}</div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>{{ master_form.status }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
                        <select name="type" id="id_type" class="{{ master_form.type.field.widget.attrs.class }}" hx-get="{% url 'hx_load_subtypes' %}" hx-target="#id_subtype">
                            <option value="">-- Select Board First --</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subtype</label>{{ master_form.subtype }}</div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Item</label>{{ master_form.item }}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>{{ master_form.priority }}</div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Source</label>{{ master_form.source }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4 border-b pb-2">2. Ticket Details</h2>
            <div id="dynamic-form-container">
                <div class="text-center py-12 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    <p>Select a <strong>Ticket Type</strong> above to load the form.</p>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-end">
            <button type="submit" class="bg-prime-orange text-white px-8 py-3 rounded-md font-bold text-sm shadow-lg hover:bg-orange-600 transition-transform transform active:scale-95">Create Ticket</button>
        </div>
    </form>
</div>

<script>
    // --- 1. Alpine Logic Component ---
    function ticketForm() {
        return {
            openContact: false,
            openTech: false,
            openCollab: false,
            
            selectedContact: null,
            selectedTech: null,
            selectedCollaborators: [], 

            handleSelection(data) {
                if (data.target === 'contact') {
                    this.selectedContact = { id: data.id, name: data.name, avatar: data.avatar };
                    this.openContact = false;
                    htmx.ajax('GET', `{% url 'hx_get_contact_info' %}?contact=${data.id}`, {target: '#contact-details'});
                } 
                else if (data.target === 'technician') {
                    this.selectedTech = { id: data.id, name: data.name, avatar: data.avatar };
                    this.openTech = false;
                }
                else if (data.target === 'collaborators') {
                    if (!this.selectedCollaborators.some(c => c.id == data.id)) {
                        this.selectedCollaborators.push({ id: data.id, name: data.name, avatar: data.avatar });
                    }
                    this.openCollab = false;
                    document.getElementById('collab-search').value = ''; 
                }
            },

            removeUser(target) {
                if (target === 'contact') {
                    this.selectedContact = null;
                    document.getElementById('contact-search').value = '';
                    document.querySelectorAll('#contact-details input').forEach(i => i.value = '');
                } else if (target === 'technician') {
                    this.selectedTech = null;
                    document.getElementById('tech-search').value = '';
                }
            }
        }
    }

    // --- 2. Global Helper for Search Results ---
    function triggerUserSelection(target, id, name, avatar) {
        const root = document.getElementById('agent-ticket-root');
        root.dispatchEvent(new CustomEvent('user-selected', {
            detail: { target, id, name, avatar }
        }));
    }

    // --- 3. "Assign to Me" Helper ---
    function assignToMe() {
        const myId = '{{ request.user.id }}';
        const myName = '{{ request.user.get_full_name|escapejs }}';
        {% if request.user.profile.avatar %}
            const myAvatar = '{{ request.user.profile.avatar.url }}';
        {% else %}
            const myAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(myName)}&background=0D8ABC&color=fff`;
        {% endif %}
        
        triggerUserSelection('technician', myId, myName, myAvatar);
    }

    // --- 4. Dynamic Form Loading ---
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'id_type') {
            var typeId = e.target.value;
            var container = document.getElementById('dynamic-form-container');
            if (typeId) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400">Loading form...</div>';
                htmx.ajax('GET', '{% url "hx_load_ticket_form" %}?type=' + typeId, {target: '#dynamic-form-container'});
            }
        }
    });
    
    // --- 5. Conditional Logic Watcher ---
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.target.id === 'dynamic-form-container') {
            handleDynamicFormLogic();
        }
    });

    function handleDynamicFormLogic() {
        const appSelect = document.getElementById('id_application_name');
        const otherAppInput = document.getElementById('id_other_application');
        if (appSelect && otherAppInput) {
            const toggle = () => { otherAppInput.closest('p, div.mb-3, div').style.display = (appSelect.value === 'Other') ? '' : 'none'; };
            appSelect.addEventListener('change', toggle);
            toggle();
        }
        const vpTypeSelect = document.getElementById('id_request_type');
        const vpOtherInput = document.getElementById('id_other_type');
        if (vpTypeSelect && vpOtherInput) {
            const toggle = () => { vpOtherInput.closest('p, div.mb-3, div').style.display = (vpTypeSelect.value === 'Other') ? '' : 'none'; };
            vpTypeSelect.addEventListener('change', toggle);
            toggle();
        }
    }
</script>
{% endblock %}