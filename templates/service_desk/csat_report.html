{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">
    
    <!-- Page Header with Date Range Controls -->
    <div class="mb-8">
        <!-- Back Navigation -->
        <div class="mb-4">
            <a href="{% url 'manager_dashboard' %}" class="text-sm text-prime-orange hover:underline inline-flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back to Manager Dashboard
            </a>
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-prime-navy">
                    {% if technician %}
                        Customer Satisfaction: <span class="text-prime-orange">{{ technician.name }}</span>
                    {% else %}
                        Overall Customer Satisfaction
                    {% endif %}
                </h1>
                <p class="text-gray-600 mt-1">Voice of the Customer</p>
            </div>

            <div class="flex items-center gap-3">
                {% if is_demo_mode %}
                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">DEMO MODE</span>
                {% endif %}

                <!-- Container A: Date Preset Buttons (Default Visible) -->
                <div id="date-preset-row" class="flex items-center space-x-2">
                    <a href="?range=today" 
                       id="btn-today"
                       class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                              {% if current_range == 'today' %}text-white bg-prime-orange border border-prime-orange
                              {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                        Today
                    </a>
                    <a href="?range=yesterday" 
                       id="btn-yesterday"
                       class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                              {% if current_range == 'yesterday' %}text-white bg-prime-orange border border-prime-orange
                              {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                        Yesterday
                    </a>
                    <a href="?range=7d" 
                       id="btn-7d"
                       class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                              {% if current_range == '7d' or not current_range %}text-white bg-prime-orange border border-prime-orange
                              {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                        Last 7 Days
                    </a>
                    <a href="?range=30d" 
                       id="btn-30d"
                       class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                              {% if current_range == '30d' %}text-white bg-prime-orange border border-prime-orange
                              {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                        Last 30 Days
                    </a>
                    <button 
                        id="btn-custom"
                        onclick="showCustomInputRow()"
                        class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                               {% if current_range == 'custom' %}text-white bg-prime-orange border border-prime-orange
                               {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                        Custom Range
                    </button>
                </div>

                <!-- Container B: Custom Date Input Row (Default Hidden, Swaps In) -->
                <form method="GET" id="custom-input-row" class="hidden flex items-center gap-2">
                    <input type="hidden" name="range" value="custom">
                    
                    <span class="text-sm text-gray-600 font-medium">From:</span>
                    <input type="date" 
                           name="start" 
                           class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-prime-orange focus:border-prime-orange" 
                           required>
                    
                    <span class="text-sm text-gray-600 font-medium">To:</span>
                    <input type="date" 
                           name="end" 
                           class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-prime-orange focus:border-prime-orange" 
                           required>
                    
                    <button type="submit" 
                            class="px-3 py-1 text-sm font-medium text-white bg-prime-orange rounded hover:bg-opacity-90 transition-colors">
                        Apply
                    </button>
                    <button type="button" 
                            onclick="hideCustomInputRow()"
                            class="px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- CSAT Score Summary Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-bold text-prime-navy mb-2">Average Rating</h3>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-1">
                        <!-- 5 Yellow Stars (Static Display) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                    </div>
                    <span class="text-3xl font-bold text-prime-navy">4.9/5</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Based on recent customer feedback</p>
            </div>
            <div class="p-4 bg-green-50 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </div>
    </div>

    <!-- Recent Customer Feedback Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-bold text-prime-navy mb-6 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
            Recent Customer Feedback
        </h3>

        <!-- Feedback List -->
        <div class="space-y-4">
            {% if technician %}
                <!-- Display Technician-Specific Feedback -->
                {% for review in technician.feedback %}
                <div class="bg-gray-50 rounded-lg shadow-sm p-4 border border-gray-100">
                    <!-- Top Row: User Name + Date -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-bold text-gray-900">{{ review.user }}</span>
                        <span class="text-xs text-gray-500">{{ review.date }}</span>
                    </div>

                    <!-- Star Rating (Dynamic based on review.rating) -->
                    <div class="flex items-center gap-1 mb-3">
                        {% for i in "12345" %}
                            {% if forloop.counter <= review.rating %}
                                <!-- Yellow Star (Filled) -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            {% else %}
                                <!-- Gray Star (Empty) -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Comment Text -->
                    <p class="text-gray-700 text-sm">"{{ review.comment }}"</p>
                </div>
                {% empty %}
                <div class="text-center text-gray-400 italic py-8">
                    No feedback available for this technician in this period.
                </div>
                {% endfor %}

            {% else %}
                <!-- Display Global Feedback from stats.recent_feedback -->
                {% for review in stats.recent_feedback %}
                <div class="bg-gray-50 rounded-lg shadow-sm p-4 border border-gray-100">
                    <!-- Top Row: User Name + Ticket Info -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-bold text-gray-900">{{ review.user }}</span>
                        <span class="text-xs text-gray-500">{{ review.ticket }}</span>
                    </div>

                    <!-- Star Rating (Dynamic based on review.rating) -->
                    <div class="flex items-center gap-1 mb-3">
                        {% for i in "12345" %}
                            {% if forloop.counter <= review.rating %}
                                <!-- Yellow Star (Filled) -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            {% else %}
                                <!-- Gray Star (Empty) -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Comment Text -->
                    <p class="text-gray-700 text-sm">"{{ review.comment }}"</p>
                </div>
                {% empty %}
                <div class="text-center text-gray-400 italic py-8">
                    No feedback available for this period.
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

</div>

<!-- Swap Mode JavaScript (Identical to Manager Dashboard) -->
<script>
    // --- SWAP MODE: SHOW CUSTOM INPUT ROW, HIDE PRESET BUTTONS ---
    function showCustomInputRow() {
        const presetRow = document.getElementById('date-preset-row');
        const customRow = document.getElementById('custom-input-row');
        
        if (presetRow && customRow) {
            presetRow.classList.add('hidden');
            customRow.classList.remove('hidden');
        }
    }

    // --- SWAP MODE: HIDE CUSTOM INPUT ROW, SHOW PRESET BUTTONS ---
    function hideCustomInputRow() {
        const presetRow = document.getElementById('date-preset-row');
        const customRow = document.getElementById('custom-input-row');
        
        if (presetRow && customRow) {
            customRow.classList.add('hidden');
            presetRow.classList.remove('hidden');
        }
    }
</script>
{% endblock %}