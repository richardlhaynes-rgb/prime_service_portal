{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">

    <!-- Block 1: Page Header -->
    <div>
        <h1 class="text-2xl font-bold text-prime-navy">System Activity Logs</h1>
        <p class="text-gray-600 text-sm mt-1">Audit trail of administrative actions</p>
    </div>

    <!-- Block 2: Main Card (Toolbar + Table) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 space-y-4">
            
            <div class="flex items-center gap-2">
                <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-5 w-5 text-prime-navy dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5h6m-6 4h6m-6 4h6M8 3h8a2 2 0 012 2v14a2 2 0 01-2 2H8a2 2 0 01-2-2V5a2 2 0 012-2z"/>
                </svg>
                <h3 class="text-lg font-semibold text-prime-navy dark:text-white">Recent Activity</h3>
            </div>

            <div class="flex flex-col xl:flex-row justify-between items-center gap-4">
                
                <div class="w-full xl:w-auto">
                     <form method="get" id="tz-form">
                        <input type="hidden" name="q" value="{{ search_query|default:'' }}">
                        <input type="hidden" name="range" value="{{ current_range|default:'7d' }}">
                        <div class="relative">
                            <select id="timezone" name="timezone" onchange="document.getElementById('tz-form').submit()" 
                                    class="w-full xl:w-auto pl-3 pr-8 py-2 text-sm rounded-md shadow-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-white focus:ring-prime-orange focus:border-prime-orange">
                                {% for tz_id, tz_label in na_timezones %}
                                    <option value="{{ tz_id }}" {% if selected_tz == tz_id %}selected{% endif %}>{{ tz_label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>

                <div class="flex-1 flex justify-center w-full xl:w-auto overflow-x-auto">
                    <form method="get" id="filter-form" class="flex items-center gap-2">
                        <input type="hidden" name="q" value="{{ search_query|default:'' }}">
                        <input type="hidden" name="timezone" value="{{ selected_tz|default:'America/New_York' }}">
                        
                        <div id="preset-buttons" class="flex gap-2 {% if current_range == 'custom' %}hidden{% endif %}">
                            {% with r=current_range|default:'7d' %}
                            <button name="range" value="today" class="whitespace-nowrap px-4 py-2 text-sm font-medium rounded-md border transition-colors shadow-sm {% if r == 'today' %}bg-prime-orange text-white border-prime-orange{% else %}bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600{% endif %}">Today</button>
                            <button name="range" value="yesterday" class="whitespace-nowrap px-4 py-2 text-sm font-medium rounded-md border transition-colors shadow-sm {% if r == 'yesterday' %}bg-prime-orange text-white border-prime-orange{% else %}bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600{% endif %}">Yesterday</button>
                            <button name="range" value="7d" class="whitespace-nowrap px-4 py-2 text-sm font-medium rounded-md border transition-colors shadow-sm {% if r == '7d' %}bg-prime-orange text-white border-prime-orange{% else %}bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600{% endif %}">Last 7 Days</button>
                            <button name="range" value="30d" class="whitespace-nowrap px-4 py-2 text-sm font-medium rounded-md border transition-colors shadow-sm {% if r == '30d' %}bg-prime-orange text-white border-prime-orange{% else %}bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600{% endif %}">Last 30 Days</button>
                            <button type="button" onclick="toggleCustomRange(true)" class="whitespace-nowrap px-4 py-2 text-sm font-medium rounded-md border shadow-sm bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600">Custom Range</button>
                            {% endwith %}
                        </div>

                        <div id="custom-inputs" class="flex items-center gap-3 {% if current_range != 'custom' %}hidden{% endif %}">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 dark:text-gray-400">From:</span>
                                <input type="date" name="start_date" value="{{ start_date|default:'' }}" class="px-3 py-2 text-sm rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:ring-prime-orange focus:border-prime-orange">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 dark:text-gray-400">To:</span>
                                <input type="date" name="end_date" value="{{ end_date|default:'' }}" class="px-3 py-2 text-sm rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:ring-prime-orange focus:border-prime-orange">
                            </div>
                            <button type="submit" name="range" value="custom" class="px-4 py-2 text-sm font-medium bg-prime-orange text-white rounded-md hover:bg-opacity-90 shadow-sm transition-colors">Apply</button>
                            <button type="button" onclick="toggleCustomRange(false)" class="px-4 py-2 text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 shadow-sm transition-colors">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="w-full xl:w-auto flex-shrink-0">
                    <form method="get" class="relative">
                        <input type="hidden" name="range" value="{{ current_range|default:'7d' }}">
                        <input type="hidden" name="timezone" value="{{ selected_tz|default:'America/New_York' }}">
                        
                        <input type="text" name="q" value="{{ search_query|default:'' }}" placeholder="Search logs..." 
                               class="w-full xl:w-64 pl-3 pr-10 py-2 text-sm rounded-md shadow-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-white focus:ring-prime-orange focus:border-prime-orange">
                        <button type="submit" class="absolute right-0 top-0 bottom-0 px-3 text-gray-400 hover:text-prime-orange">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th scope="col" class="w-64 whitespace-nowrap px-6 py-3 text-left text-xs font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                            <a href="?sort={% if current_sort == 'timestamp' %}-timestamp{% else %}timestamp{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if selected_tz %}&timezone={{ selected_tz|urlencode }}{% endif %}" class="inline-flex items-center gap-1 hover:text-prime-orange">
                                Date/Time ({{ selected_tz|slice:"8:" }})
                                {% if current_sort == 'timestamp' %}&uarr;{% elif current_sort == '-timestamp' %}&darr;{% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                            <a href="?sort={% if current_sort == 'user' %}-user{% else %}user{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if selected_tz %}&timezone={{ selected_tz|urlencode }}{% endif %}" class="inline-flex items-center gap-1 hover:text-prime-orange">
                                User
                                {% if current_sort == 'user' %}&uarr;{% elif current_sort == '-user' %}&darr;{% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                            <a href="?sort={% if current_sort == 'action' %}-action{% else %}action{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if selected_tz %}&timezone={{ selected_tz|urlencode }}{% endif %}" class="inline-flex items-center justify-center gap-1 hover:text-prime-orange">
                                Action
                                {% if current_sort == 'action' %}&uarr;{% elif current_sort == '-action' %}&darr;{% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider">Target</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider">Details</th>
                    </tr>
                </thead>

                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for log in logs %}
                    <tr class="group hover:bg-gray-50 dark:hover:bg-gray-700/50 transition duration-150">
                        <!-- Date -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="font-mono text-xs text-gray-700 dark:text-gray-300">
                                {{ log.dt_obj|date:"n/j/Y g:i A" }}
                            </span>
                        </td>
                        <!-- User -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-semibold text-prime-navy dark:text-white">{{ log.user }}</span>
                        </td>
                        <!-- Action Icon -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex justify-center w-full">
                                {% with action_lower=log.action|lower %}
                                    {% if 'update' in action_lower or 'edit' in action_lower %}
                                        <span class="h-8 w-8 rounded-full bg-indigo-50 text-indigo-600 dark:bg-indigo-900/40 dark:text-indigo-300 flex items-center justify-center" title="{{ log.action }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                                            </svg>
                                        </span>
                                    {% elif 'create' in action_lower or 'add' in action_lower %}
                                        <span class="h-8 w-8 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 border border-green-200 dark:border-green-900/30 flex items-center justify-center" title="{{ log.action }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                        </span>
                                    {% elif 'delete' in action_lower %}
                                        <span class="h-8 w-8 rounded-full bg-red-50 text-red-600 flex items-center justify-center" title="{{ log.action }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </span>
                                    {% elif 'login' in action_lower %}
                                        <span class="h-8 w-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center" title="{{ log.action }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </span>
                                    {% else %}
                                        <span class="h-8 w-8 rounded-full bg-gray-50 text-gray-500 flex items-center justify-center" title="{{ log.action }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </td>
                        <!-- Target -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900 dark:text-gray-300">{{ log.target }}</span>
                        </td>
                        <!-- Details -->
                        <td class="px-6 py-4">
                            <span class="text-sm text-gray-700 dark:text-gray-300">{{ log.details }}</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 dark:text-gray-600 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V7a2 2 0 00-2-2h-3l-2-2H9L7 5H4a2 2 0 00-2 2v6m18 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4m18 0H2m18 0l-3-3H7l-3 3" />
                                </svg>
                                <p class="font-medium text-gray-700 dark:text-gray-300">No system activity recorded yet.</p>
                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Admin actions will appear here.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="log-pagination" class="bg-gray-50 dark:bg-gray-800 px-6 py-3 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between hidden">
                <button onclick="changeLogPage(-1)" id="btn-prev-log" class="px-3 py-1 text-sm font-medium text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    &larr; Previous
                </button>
                <span id="log-indicator" class="text-sm text-gray-600 dark:text-gray-300 font-medium">
                    Page 1 of 1
                </span>
                <button onclick="changeLogPage(1)" id="btn-next-log" class="px-3 py-1 text-sm font-medium text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next &rarr;
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentLogPage = 1;
    const logsPerPage = 15;
    const logRows = Array.from(document.querySelectorAll('tbody tr')); // All rows

    function renderLogPage() {
        const controls = document.getElementById('log-pagination');
        const btnPrev = document.getElementById('btn-prev-log');
        const btnNext = document.getElementById('btn-next-log');
        const indicator = document.getElementById('log-indicator');
        
        // Hide all rows first
        logRows.forEach(row => row.style.display = 'none');

        const totalPages = Math.ceil(logRows.length / logsPerPage);

        // Hide controls if 1 page or empty
        if (logRows.length === 0 || totalPages <= 1) {
            controls.classList.add('hidden');
            logRows.forEach(row => row.style.display = ''); // Show all if short
            return;
        } else {
            controls.classList.remove('hidden');
        }

        // Show Slice
        const start = (currentLogPage - 1) * logsPerPage;
        const end = start + logsPerPage;
        logRows.slice(start, end).forEach(row => row.style.display = '');

        // Update Controls
        indicator.textContent = `Page ${currentLogPage} of ${totalPages}`;
        btnPrev.disabled = (currentLogPage === 1);
        btnNext.disabled = (currentLogPage === totalPages);
    }

    function changeLogPage(delta) {
        const totalPages = Math.ceil(logRows.length / logsPerPage);
        const newPage = currentLogPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentLogPage = newPage;
            renderLogPage();
        }
    }

    // Initialize on Load
    document.addEventListener('DOMContentLoaded', function() {
        renderLogPage();
    });

    function toggleCustomRange(show) {
        const buttons = document.getElementById('preset-buttons');
        const inputs = document.getElementById('custom-inputs');
        if (show) {
            buttons.classList.add('hidden');
            inputs.classList.remove('hidden');
        } else {
            buttons.classList.remove('hidden');
            inputs.classList.add('hidden');
        }
    }
</script>
{% endblock %}