{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
    
    <div class="lg:col-span-3 space-y-6">
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-prime-navy dark:text-white">Ticket #{{ ticket.id }}</h1>
                        <span class="px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-full 
                            {% if ticket.status == 'New' %} bg-blue-100 text-blue-800
                            {% elif ticket.status == 'Resolved' %} bg-green-100 text-green-800
                            {% elif ticket.status == 'Closed' %} bg-gray-100 text-gray-800
                            {% else %} bg-yellow-100 text-yellow-800 {% endif %}">
                            {{ ticket.get_status_display }}
                        </span>
                    </div>
                    <h2 class="text-xl text-gray-800 dark:text-gray-100 mt-1">{{ ticket.title }}</h2>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Submitted By</div>
                    <div class="font-bold text-prime-navy dark:text-white flex items-center justify-end gap-2">
                        {% if ticket.submitter.profile.avatar %}
                            <img src="{{ ticket.submitter.profile.avatar.url }}" class="w-6 h-6 rounded-full">
                        {% endif %}
                        {{ ticket.submitter.get_full_name|default:ticket.submitter.username }}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">{{ ticket.created_at|date:"M d, Y g:i A" }}</div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-gray-100 dark:border-gray-700">
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Board</label>
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200">{{ ticket.board.name }}</div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Type</label>
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200">{{ ticket.type.name }}</div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Technician</label>
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200">
                        {% if ticket.technician %}
                            {{ ticket.technician.get_full_name }}
                        {% else %}
                            <span class="text-gray-400 italic">Unassigned</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Priority</label>
                    <div class="text-sm font-bold 
                        {% if ticket.priority == 'P1' %}text-red-600
                        {% elif ticket.priority == 'P2' %}text-orange-500
                        {% else %}text-gray-600{% endif %}">
                        {{ ticket.get_priority_display }}
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Description</h3>
                <div class="prose max-w-none text-sm text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800 p-4 border rounded-md">
                    {{ ticket.description|linebreaks }}
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">Specific Details</h3>
                    
                    {% if ticket.form_data %}
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-y-4 gap-x-8">
                        {% for key, value in ticket.form_data.items %}
                            {% if key != 'description' and key != 'summary' and key != 'csrfmiddlewaretoken' %}
                            <div>
                                <span class="block text-[10px] uppercase text-gray-400 mb-0.5">{{ key|title|cut:"_" }}</span>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">{{ value }}</span>
                            </div>
                            {% endif %}
                        {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-400 italic">No specific details captured for this ticket.</div>
                    {% endif %}
                </div>
                
                {% if ticket.attachment %}
                <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h5 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">Attachments</h5>
                    <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd" />
                        </svg>
                        <a href="{{ ticket.attachment.url }}" target="_blank" class="text-sm font-medium text-prime-orange hover:underline">
                            {{ ticket.filename }}
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div>
            <h3 class="text-lg font-bold text-prime-navy dark:text-white mb-4">Activity Log</h3>
            <div id="activity-log">
                {% include 'service_desk/partials/ticket_activities.html' %}
            </div>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-5 sticky top-6">
            <h3 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wide mb-4 border-b pb-2">Manage Ticket</h3>
            
            <form method="post" id="ticket-update-form" autocomplete="off"
                  x-data="ticketManager({{ current_tech_json|default:'null' }}, {{ current_collaborators_json|default:'[]' }})"
                  @user-selected="handleSelection($event.detail)">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Board</label>
                    <select name="board" id="id_board" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        {% for board in boards %}
                            <option value="{{ board.id }}" {% if ticket.board.id == board.id %}selected{% endif %}>{{ board.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Status</label>
                    <select name="status" id="id_status" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        {% for code, label in status_choices %}
                            <option value="{{ code }}" {% if ticket.status == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4 relative" @click.away="openTech = false">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-xs font-medium text-gray-500">Assignee</label>
                        <button type="button" x-show="!selectedTech" class="text-xs text-prime-orange font-bold hover:underline" onclick="assignToMe()">Assign to Me</button>
                    </div>
                    
                    <input type="hidden" name="technician" id="id_technician" :value="selectedTech ? selectedTech.id : ''">
                    
                    <div x-show="!selectedTech">
                        <input type="text" id="tech-search" name="q"
                               class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 placeholder-gray-400"
                               placeholder="Unassigned"
                               autocomplete="off"
                               @focus="openTech = true"
                               hx-get="{% url 'hx_search_users' %}"
                               hx-trigger="keyup changed delay:200ms, focus"
                               hx-target="#tech-results"
                               hx-vals='{"target": "technician", "variant": "compact"}'>
                        
                        <div id="tech-results" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md shadow-lg max-h-48 overflow-y-auto" x-show="openTech" style="display: none;"></div>
                    </div>

                    <div x-show="selectedTech" style="display: none;" class="flex items-center justify-between p-2 pl-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-md shadow-sm">
                        <div class="flex items-center gap-3">
                            <img :src="selectedTech?.avatar" class="w-6 h-6 rounded-full border border-purple-200 dark:border-purple-700 object-cover">
                            <div>
                                <p class="text-xs font-bold text-prime-navy dark:text-white" x-text="selectedTech?.name"></p>
                            </div>
                        </div>
                        <button type="button" @click="removeUser('technician')" class="p-1 text-gray-400 hover:text-red-500 rounded-full hover:bg-white dark:hover:bg-gray-800 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>

                <div class="mb-4 relative" @click.away="openCollab = false">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Collaborators</label>
                    
                    <template x-for="c in selectedCollaborators" :key="c.id">
                        <input type="hidden" name="collaborators" :value="c.id">
                    </template>

                    <input type="text" id="collab-search" name="q"
                           class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 placeholder-gray-400"
                           placeholder="Add technician..."
                           autocomplete="off"
                           @focus="openCollab = true"
                           hx-get="{% url 'hx_search_users' %}"
                           hx-trigger="keyup changed delay:200ms, focus"
                           hx-target="#collab-results"
                           hx-vals='{"target": "collaborators", "variant": "compact"}'>
                    
                    <div id="collab-results" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md shadow-lg max-h-48 overflow-y-auto" x-show="openCollab" style="display: none;"></div>

                    <div class="flex flex-wrap gap-1.5 mt-2">
                        <template x-for="(c, index) in selectedCollaborators" :key="c.id">
                            <div class="inline-flex items-center bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-full px-2 py-0.5">
                                <img :src="c.avatar" class="w-4 h-4 rounded-full mr-1.5">
                                <span class="text-[10px] font-bold text-gray-700 dark:text-gray-200" x-text="c.name"></span>
                                <button type="button" @click="removeCollaborator(index)" class="ml-1 text-gray-400 hover:text-red-500">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Priority</label>
                    <select name="priority" id="id_priority" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="P1" {% if ticket.priority == 'P1' %}selected{% endif %}>P1 - Critical</option>
                        <option value="P2" {% if ticket.priority == 'P2' %}selected{% endif %}>P2 - High</option>
                        <option value="P3" {% if ticket.priority == 'P3' %}selected{% endif %}>P3 - Normal</option>
                        <option value="P4" {% if ticket.priority == 'P4' %}selected{% endif %}>P4 - Low</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Quick Reply</label>
                    <textarea name="comment" id="id_comment" rows="3" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="Add an internal note or reply..."></textarea>
                </div>

                <div class="mb-6 flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded border border-gray-200 dark:border-gray-700">
                    {% if ticket.status == 'Resolved' or ticket.status == 'Closed' %}
                        <input type="checkbox" name="reopen_ticket" id="id_reopen_ticket" class="rounded text-green-600 focus:ring-green-500">
                        <label for="id_reopen_ticket" class="text-sm font-semibold text-green-700 dark:text-green-400">Reopen Ticket</label>
                    {% else %}
                        <input type="checkbox" name="close_ticket" id="id_close_ticket" class="rounded text-prime-orange focus:ring-prime-orange">
                        <label for="id_close_ticket" class="text-sm text-gray-700 dark:text-gray-300 font-medium">Mark as Resolved</label>
                    {% endif %}
                </div>

                <button type="submit" id="submit-update-btn" class="w-full bg-prime-orange text-white py-2 px-4 rounded-md font-bold hover:bg-orange-600 transition">
                    Update Ticket
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // 1. Alpine Component for Sidebar Logic
    function ticketManager(initialTech, initialCollaborators) {
        return {
            openTech: false,
            openCollab: false,
            
            selectedTech: initialTech || null,
            selectedCollaborators: initialCollaborators || [],

            handleSelection(data) {
                if (data.target === 'technician') {
                    this.selectedTech = { id: data.id, name: data.name, avatar: data.avatar };
                    this.openTech = false;
                    document.getElementById('tech-search').value = '';
                    this.enableSubmit();
                }
                else if (data.target === 'collaborators') {
                    if (!this.selectedCollaborators.some(c => c.id == data.id)) {
                        this.selectedCollaborators.push({ id: data.id, name: data.name, avatar: data.avatar });
                        this.enableSubmit();
                    }
                    this.openCollab = false;
                    document.getElementById('collab-search').value = ''; 
                }
            },

            removeUser(target) {
                if (target === 'technician') {
                    this.selectedTech = null;
                    document.getElementById('tech-search').value = '';
                    this.enableSubmit();
                }
            },

            removeCollaborator(index) {
                this.selectedCollaborators.splice(index, 1);
                this.enableSubmit();
            },
            
            enableSubmit() {
                const btn = document.getElementById('submit-update-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }
    }

    // 2. Global Event Helper
    function triggerUserSelection(target, id, name, avatar) {
        const form = document.getElementById('ticket-update-form');
        form.dispatchEvent(new CustomEvent('user-selected', {
            detail: { target, id, name, avatar }
        }));
    }

    // 3. "Assign to Me" Logic
    function assignToMe() {
        const myId = '{{ request.user.id }}';
        const myName = '{{ request.user.get_full_name|escapejs }}';
        {% if request.user.profile.avatar %}
            const myAvatar = '{{ request.user.profile.avatar.url }}';
        {% else %}
            const myAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(myName)}&background=0D8ABC&color=fff`;
        {% endif %}
        
        triggerUserSelection('technician', myId, myName, myAvatar);
    }

    // 4. Dirty Form Checker
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('ticket-update-form');
        const submitBtn = document.getElementById('submit-update-btn');
        // Initial state: disabled until user interacts
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

        const inputs = ['id_board', 'id_status', 'id_priority', 'id_comment', 'id_close_ticket', 'id_reopen_ticket'];
        let initialValues = {};

        if (!form) return;

        inputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                initialValues[id] = el.type === 'checkbox' ? el.checked : el.value;
                el.addEventListener('input', checkDirty);
                el.addEventListener('change', checkDirty);
            }
        });

        function checkDirty() {
            let isDirty = false;
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const currentVal = el.type === 'checkbox' ? el.checked : el.value;
                if (currentVal !== initialValues[id]) isDirty = true;
                if (id === 'id_comment' && currentVal.trim() !== '') isDirty = true;
            });

            // Note: Tech/Collab changes are handled via Alpine's 'enableSubmit'
            if (isDirty) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    });
</script>
{% endblock %}