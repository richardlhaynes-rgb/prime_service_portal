{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
    
    <div class="lg:col-span-3 space-y-6">
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-prime-navy dark:text-white">Ticket #{{ ticket.id }}</h1>
                        <span class="px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-full 
                            {% if ticket.status == 'New' %} bg-blue-100 text-blue-800
                            {% elif ticket.status == 'Resolved' %} bg-green-100 text-green-800
                            {% elif ticket.status == 'Closed' %} bg-gray-100 text-gray-800
                            {% else %} bg-yellow-100 text-yellow-800 {% endif %}">
                            {{ ticket.get_status_display }}
                        </span>
                    </div>
                    <h2 class="text-xl text-gray-800 dark:text-gray-100 mt-1">{{ ticket.title }}</h2>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Submitted By</div>
                    <div class="font-bold text-prime-navy dark:text-white flex items-center justify-end gap-2">
                        {% if ticket.submitter.profile.avatar %}
                            <img src="{{ ticket.submitter.profile.avatar.url }}" class="w-6 h-6 rounded-full">
                        {% endif %}
                        {{ ticket.submitter.get_full_name|default:ticket.submitter.username }}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">{{ ticket.created_at|date:"M d, Y g:i A" }}</div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-gray-100 dark:border-gray-700">
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Board</label>
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200">{{ ticket.board.name }}</div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Type</label>
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200">{{ ticket.type.name }}</div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Technician</label>
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200">
                        {% if ticket.technician %}
                            {{ ticket.technician.get_full_name }}
                        {% else %}
                            <span class="text-gray-400 italic">Unassigned</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-gray-400">Priority</label>
                    <div class="text-sm font-bold 
                        {% if ticket.priority == 'P1' %}text-red-600
                        {% elif ticket.priority == 'P2' %}text-orange-500
                        {% else %}text-gray-600{% endif %}">
                        {{ ticket.get_priority_display }}
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Description</h3>
                <div class="prose max-w-none text-sm text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800 p-4 border rounded-md">
                    {{ ticket.description|linebreaks }}
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">Specific Details</h3>
                    
                    {% if ticket.form_data %}
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-y-4 gap-x-8">
                        {% for key, value in ticket.form_data.items %}
                            {% if key != 'description' and key != 'summary' and key != 'csrfmiddlewaretoken' %}
                            <div>
                                <span class="block text-[10px] uppercase text-gray-400 mb-0.5">{{ key|title|cut:"_" }}</span>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">{{ value }}</span>
                            </div>
                            {% endif %}
                        {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-400 italic">No specific details captured for this ticket.</div>
                    {% endif %}
                </div>
                
                {% if ticket.attachment %}
                <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h5 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">Attachments</h5>
                    <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd" />
                        </svg>
                        <a href="{{ ticket.attachment.url }}" target="_blank" class="text-sm font-medium text-prime-orange hover:underline">
                            {{ ticket.filename }}
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div>
            <h3 class="text-lg font-bold text-prime-navy dark:text-white mb-4">Activity Log</h3>
            <div id="activity-log">
                {% include 'service_desk/partials/ticket_activities.html' %}
            </div>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-5 sticky top-6">
            <h3 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wide mb-4 border-b pb-2">Manage Ticket</h3>
            <!-- Remove the "Partial Update" instructions and force a standard "Full Page Refresh." -->
            <!-- With autocomplete="off": The browser ignores its cache. It renders exactly what the server sends -->
            <form method="post" id="ticket-update-form" autocomplete="off">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Board</label>
                    <select name="board" id="id_board" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        {% for board in boards %}
                            <option value="{{ board.id }}" {% if ticket.board.id == board.id %}selected{% endif %}>
                                {{ board.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Status</label>
                    <select name="status" id="id_status" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        {% for code, label in status_choices %}
                            <option value="{{ code }}" {% if ticket.status == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Assigned To</label>
                    <select name="technician" id="id_technician" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="">-- Unassigned --</option>
                        {% for tech in technicians %}
                            <option value="{{ tech.id }}" {% if ticket.technician == tech %}selected{% endif %}>
                                {{ tech.get_full_name|default:tech.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Priority</label>
                    <select name="priority" id="id_priority" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="P1" {% if ticket.priority == 'P1' %}selected{% endif %}>P1 - Critical</option>
                        <option value="P2" {% if ticket.priority == 'P2' %}selected{% endif %}>P2 - High</option>
                        <option value="P3" {% if ticket.priority == 'P3' %}selected{% endif %}>P3 - Normal</option>
                        <option value="P4" {% if ticket.priority == 'P4' %}selected{% endif %}>P4 - Low</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Quick Reply</label>
                    <textarea name="comment" id="id_comment" rows="3" class="w-full text-sm border-gray-300 rounded-md focus:ring-prime-orange focus:border-prime-orange bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="Add an internal note or reply..."></textarea>
                </div>

                <div class="mb-6 flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded border border-gray-200 dark:border-gray-700">
                    {% if ticket.status == 'Resolved' or ticket.status == 'Closed' %}
                        <input type="checkbox" name="reopen_ticket" id="id_reopen_ticket" class="rounded text-green-600 focus:ring-green-500">
                        <label for="id_reopen_ticket" class="text-sm font-semibold text-green-700 dark:text-green-400">Reopen Ticket</label>
                    {% else %}
                        <input type="checkbox" name="close_ticket" id="id_close_ticket" class="rounded text-prime-orange focus:ring-prime-orange">
                        <label for="id_close_ticket" class="text-sm text-gray-700 dark:text-gray-300 font-medium">Mark as Resolved</label>
                    {% endif %}
                </div>

                <button type="submit" id="submit-update-btn" disabled class="w-full bg-prime-orange text-white py-2 px-4 rounded-md font-bold hover:bg-orange-600 transition opacity-50 cursor-not-allowed">
                    Update Ticket
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('ticket-update-form');
    const submitBtn = document.getElementById('submit-update-btn');
    const inputs = ['id_board', 'id_status', 'id_technician', 'id_priority', 'id_comment', 'id_close_ticket', 'id_reopen_ticket'];
    let initialValues = {};

    if (!form || !submitBtn) return;

    // Capture initial state
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            initialValues[id] = el.type === 'checkbox' ? el.checked : el.value;
            el.addEventListener('input', checkDirty);
            el.addEventListener('change', checkDirty);
        }
    });

    function checkDirty() {
        let isDirty = false;
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const currentVal = el.type === 'checkbox' ? el.checked : el.value;
            if (currentVal !== initialValues[id]) isDirty = true;
            if (id === 'id_comment' && currentVal.trim() !== '') isDirty = true;
        });

        if (isDirty) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
});
</script>
{% endblock %}