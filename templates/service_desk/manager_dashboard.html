{% extends 'base.html' %}

{% block content %}
<div class="space-y-8">
    
    <!-- Page Header with Date Range Controls -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-prime-navy">Manager Analytics Dashboard</h1>
            <p class="text-gray-600 mt-1">Team performance and ticket metrics</p>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Container A: Date Preset Buttons (Default Visible) -->
            <div id="date-preset-row" class="flex items-center space-x-2">
                <a href="?range=today" 
                   id="btn-today"
                   class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                          {% if current_range == 'today' %}text-white bg-prime-orange border border-prime-orange
                          {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                    Today
                </a>
                <a href="?range=yesterday" 
                   id="btn-yesterday"
                   class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                          {% if current_range == 'yesterday' %}text-white bg-prime-orange border border-prime-orange
                          {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                    Yesterday
                </a>
                <a href="?range=7d" 
                   id="btn-7d"
                   class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                          {% if current_range == '7d' or not current_range %}text-white bg-prime-orange border border-prime-orange
                          {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                    Last 7 Days
                </a>
                <a href="?range=30d" 
                   id="btn-30d"
                   class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                          {% if current_range == '30d' %}text-white bg-prime-orange border border-prime-orange
                          {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                    Last 30 Days
                </a>
                <button 
                    type="button"
                    id="btn-custom"
                    onclick="toggleCustomRange()"
                    class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                           {% if current_range == 'custom' %}text-white bg-prime-orange border border-prime-orange
                           {% else %}text-gray-600 bg-white border border-gray-300 hover:bg-gray-50{% endif %}">
                    Custom Range
                </button>
            </div>

            <!-- Container B: Custom Date Input Row (Default Hidden, Swaps In) -->
            <form method="GET" id="custom-input-row" class="hidden flex items-center gap-2">
                <input type="hidden" name="range" value="custom">
                
                <span class="text-sm text-gray-600 font-medium">From:</span>
                <input type="date" 
                       name="start" 
                       value="{{ request.GET.start|default:'' }}"
                       class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-prime-orange focus:border-prime-orange" 
                       required>
                
                <span class="text-sm text-gray-600 font-medium">To:</span>
                <input type="date" 
                       name="end" 
                       value="{{ request.GET.end|default:'' }}"
                       class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-prime-orange focus:border-prime-orange" 
                       required>
                
                <button type="submit" 
                        class="px-3 py-1 text-sm font-medium text-white bg-prime-orange rounded hover:bg-opacity-90 transition-colors">
                    Apply
                </button>
                <button type="button" 
                        onclick="toggleCustomRange()"
                        class="px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
            </form>
        </div>
    </div>

    <!-- Summary Stats Row (4-Column Grid) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Tickets -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 border-l-4 border-l-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Total Tickets</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ analytics.total_tickets }}</p>
                </div>
                <div class="p-3 bg-blue-50 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Avg Resolution Time -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 border-l-4 border-l-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Avg Resolution</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ analytics.avg_resolution_time }}</p>
                </div>
                <div class="p-3 bg-green-50 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- First Response Time -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 border-l-4 border-l-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">First Response</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ analytics.first_response_time }}</p>
                </div>
                <div class="p-3 bg-purple-50 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Priority Escalations -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 border-l-4 border-l-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Priority Escalations</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ analytics.sla_breaches|length|default:"0" }}</p>
                </div>
                <div class="p-3 bg-red-50 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Priority Attention Required (SLA Breach Alert) -->
    {% if analytics.sla_breaches %}
    <div class="bg-red-50 border-l-4 border-red-500 rounded-lg shadow-sm p-6">
        <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="flex-grow">
                <h3 class="text-lg font-bold text-red-800">⚠️ Priority Attention Required</h3>
                <p class="text-sm text-red-700 mt-1">The following tickets have exceeded response time thresholds:</p>
                <ul class="mt-3 space-y-2">
                    {% for breach in analytics.sla_breaches %}
                    <li class="flex items-center justify-between bg-white rounded-lg p-3 border border-red-200">
                        <div>
                            <span class="font-bold text-gray-800">Ticket #{{ breach.ticket_id }}</span>
                            <span class="text-gray-600 ml-2">{{ breach.title }}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-red-600 font-semibold">{{ breach.age_hours }} hours old</span>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Service Desk Team Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <!-- Header with Heroicon -->
        <div class="flex items-center gap-2 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-prime-navy" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <h3 class="text-xl font-bold text-prime-navy">Service Desk Team</h3>
        </div>
        
        <!-- Team Roster Grid (Compact Horizontal Cards) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for tech in analytics.roster %}
            <a href="{% url 'technician_profile' name=tech.id %}" 
               class="flex flex-row items-center p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-lg hover:border-prime-orange transition-all duration-200 cursor-pointer">
                <!-- Avatar -->
                <img src="{{ tech.avatar }}" alt="{{ tech.name }}" class="h-12 w-12 rounded-full shadow-sm shrink-0">
                
                <!-- Name & Role -->
                <div class="ml-4 flex-grow">
                    <h4 class="font-bold text-gray-800 text-sm">{{ tech.name }}</h4>
                    <p class="text-xs text-gray-600">{{ tech.role }}</p>
                </div>
                
                <!-- Status Badge -->
                <div class="ml-auto shrink-0">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold
                        {% if tech.stats.open_tickets == 0 %}bg-green-100 text-green-800
                        {% elif tech.stats.open_tickets <= 5 %}bg-yellow-100 text-yellow-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ tech.stats.open_tickets }} Open
                    </span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Performance Charts Section (2x2 Grid with h-80 Constraint) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Chart 1: Volume by Status (Pie Chart) -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                </svg>
                <h3 class="text-lg font-bold text-prime-navy">Volume by Status</h3>
            </div>
            <div class="h-80">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Tickets by Type (Bar Chart) -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 01-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <h3 class="text-lg font-bold text-prime-navy">Tickets by Type</h3>
            </div>
            <div class="h-80">
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Trend Over Time (Line Chart) -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                </svg>
                <h3 class="text-lg font-bold text-prime-navy">Trend Analysis</h3>
            </div>
            <div class="h-80">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Chart 4: Avg Resolution Time by Technician (Horizontal Bar) -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-lg font-bold text-prime-navy">Avg Resolution Time (Hours)</h3>
            </div>
            <div class="h-80">
                <canvas id="resolutionChart"></canvas>
            </div>
        </div>

    </div>

</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Dashboard Scripts -->
<script>
    // ==========================================
    // DATE RANGE TOGGLE SYSTEM
    // ==========================================
    function toggleCustomRange() {
        const presetRow = document.getElementById('date-preset-row');
        const customRow = document.getElementById('custom-input-row');
        
        if (!presetRow || !customRow) {
            console.error('Date range toggle elements not found');
            return;
        }
        
        const isCustomVisible = !customRow.classList.contains('hidden');
        
        if (isCustomVisible) {
            // Switch back to presets
            customRow.classList.add('hidden');
            presetRow.classList.remove('hidden');
        } else {
            // Switch to custom inputs
            presetRow.classList.add('hidden');
            customRow.classList.remove('hidden');
        }
    }

    // Auto-show custom inputs if current_range is 'custom'
    document.addEventListener('DOMContentLoaded', function() {
        const currentRange = "{{ current_range|default:'7d' }}";
        if (currentRange === 'custom') {
            toggleCustomRange();
        }
    });

    // ==========================================
    // CHART.JS INITIALIZATION
    // ==========================================
    
    // Safe Chart Initialization Helper
    function initChart(canvasId, configBuilder) {
        try {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(`Chart canvas not found: ${canvasId}`);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const config = configBuilder();
            
            // Validation
            if (!config || !config.type || !config.data) {
                console.warn(`Invalid chart config for ${canvasId}`, config);
                return;
            }
            
            // Ensure data structure exists
            if (!config.data.labels || !Array.isArray(config.data.labels)) {
                config.data.labels = [];
            }
            if (!config.data.datasets || !Array.isArray(config.data.datasets)) {
                config.data.datasets = [];
            }
            
            // Create the chart
            new Chart(ctx, config);
            
        } catch (err) {
            console.error(`Chart initialization failed for ${canvasId}:`, err);
            
            // Show fallback message
            const canvas = document.getElementById(canvasId);
            if (canvas && canvas.parentElement) {
                const fallback = document.createElement('div');
                fallback.className = 'p-4 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-700 mt-2';
                fallback.textContent = `Unable to render chart. Error: ${err.message}`;
                canvas.parentElement.appendChild(fallback);
            }
        }
    }

    // Initialize all charts when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        
        // Chart 1: Volume by Status (Pie)
        initChart('statusChart', function() {
            return {
                type: 'pie',
                data: {
                    labels: {{ analytics.volume_by_status.labels|safe }},
                    datasets: [{
                        data: {{ analytics.volume_by_status.data|safe }},
                        backgroundColor: ['#FBBF24', '#A78BFA', '#34D399', '#9CA3AF'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            };
        });

        // Chart 2: Tickets by Type (Bar)
        initChart('typeChart', function() {
            return {
                type: 'bar',
                data: {
                    labels: {{ analytics.tickets_by_type.labels|safe }},
                    datasets: [{
                        label: 'Tickets',
                        data: {{ analytics.tickets_by_type.data|safe }},
                        backgroundColor: '#F15C2B',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            };
        });

        // Chart 3: Trend Analysis (Line)
        initChart('trendChart', function() {
            return {
                type: 'line',
                data: {
                    labels: {{ analytics.trend_data.labels|safe }},
                    datasets: [{
                        label: 'Tickets',
                        data: {{ analytics.trend_data.data|safe }},
                        borderColor: '#003E52',
                        backgroundColor: 'rgba(0, 62, 82, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#003E52'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { stepSize: 5 }
                        } 
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            };
        });

        // Chart 4: Avg Resolution Time (Horizontal Bar)
        initChart('resolutionChart', function() {
            return {
                type: 'bar',
                data: {
                    labels: {{ analytics.avg_resolution_time_by_member.labels|safe }},
                    datasets: [{
                        label: 'Hours',
                        data: {{ analytics.avg_resolution_time_by_member.data|safe }},
                        backgroundColor: '#10B981',
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        x: { 
                            beginAtZero: true,
                            ticks: { stepSize: 2 }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            };
        });
        
    });
</script>
{% endblock %}